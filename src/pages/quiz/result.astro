---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE } from '../../consts';
---

<!doctype html>
<html lang="zh-Hant">
	<head>
		<BaseHead
			title={`測驗結果 - ${SITE_TITLE}`}
			description="你的代謝年齡測驗結果"
		/>
	</head>
	<body>
		<Header />
		<main class="result-page">
			<div class="result-container">
				<!-- Loading state -->
				<div id="loading" class="loading">
					<p>計算你的代謝年齡中...</p>
				</div>

				<!-- Result content -->
				<div id="result-content" style="display: none;">
					<div class="result-card">
						<h1>你的代謝年齡</h1>
						<div class="age-display">
							<span id="metabolic-age" class="metabolic-age">--</span>
							<span class="age-unit">歲</span>
						</div>
						<p class="actual-age">實際年齡：<span id="actual-age">--</span> 歲</p>
						<div id="age-diff" class="age-diff"></div>
					</div>

					<div class="risk-section">
						<h2>你的主要代謝風險</h2>
						<ul id="risk-list" class="risk-list">
							<!-- Populated by JS -->
						</ul>
					</div>

					<div class="email-sent">
						<p>完整報告已寄送到 <strong id="user-email">your@email.com</strong></p>
					</div>

					<div class="video-recommend">
						<h2>推薦你先看這支影片</h2>
						<div class="video-embed">
							<iframe
								id="recommended-video"
								width="560"
								height="315"
								src="https://www.youtube.com/embed/VIDEO_ID"
								title="推薦影片"
								frameborder="0"
								allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
								allowfullscreen>
							</iframe>
						</div>
					</div>

					<div class="cta-section">
						<h2>想要逆轉代謝年齡？</h2>
						<p>預約免費諮詢，讓阿杰博士協助你打造專屬的代謝改善計畫</p>
						<a href="/booking" class="cta-btn">預約免費諮詢</a>
						<a href="/" class="back-link">← 返回首頁</a>
					</div>
				</div>

				<!-- No data state -->
				<div id="no-data" style="display: none;">
					<h1>尚未完成測驗</h1>
					<p>請先完成代謝年齡測驗</p>
					<a href="/quiz" class="cta-btn">開始測驗</a>
				</div>
			</div>
		</main>
		<Footer />

		<style>
			.result-page {
				padding: 3rem 1.5rem;
				background: linear-gradient(180deg, var(--bg-mint) 0%, var(--bg-cream) 100%);
				min-height: 100vh;
			}

			.result-container {
				max-width: 640px;
				margin: 0 auto;
			}

			.loading {
				text-align: center;
				padding: 5rem 2rem;
				color: rgb(var(--gray));
			}

			.result-card {
				background: white;
				padding: 3rem 2rem;
				border-radius: var(--border-radius-lg);
				box-shadow: var(--box-shadow-md);
				text-align: center;
				margin-bottom: 2rem;
			}

			.result-card h1 {
				color: var(--accent);
				font-size: 0.85rem;
				text-transform: uppercase;
				letter-spacing: 0.12em;
				margin-bottom: 1.5rem;
				font-weight: 600;
			}

			.age-display {
				margin-bottom: 0.75rem;
			}

			.metabolic-age {
				font-size: 4.5rem;
				font-weight: 700;
				line-height: 1;
				letter-spacing: -0.03em;
			}

			.age-unit {
				font-size: 1.75rem;
				color: rgb(var(--gray));
				font-weight: 500;
			}

			.actual-age {
				color: rgb(var(--gray));
				margin-bottom: 1.25rem;
				font-size: 0.95rem;
			}

			.age-diff {
				font-size: 0.95rem;
				font-weight: 600;
				padding: 0.75rem 1.5rem;
				border-radius: var(--border-radius-xl);
				display: inline-block;
			}

			.age-diff.warning {
				background: #fef3c7;
				color: #b45309;
			}

			.age-diff.danger {
				background: #fee2e2;
				color: #b91c1c;
			}

			.age-diff.good {
				background: var(--bg-mint);
				color: var(--accent);
			}

			/* Risk section */
			.risk-section {
				background: white;
				padding: 2rem;
				border-radius: var(--border-radius-lg);
				box-shadow: var(--box-shadow);
				margin-bottom: 2rem;
			}

			.risk-section h2 {
				font-size: 1.1rem;
				color: rgb(var(--black));
				margin-bottom: 1.25rem;
				font-weight: 600;
			}

			.risk-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}

			.risk-list li {
				padding: 0.75rem 0;
				border-bottom: 1px solid rgba(0, 0, 0, 0.04);
				color: rgb(var(--gray));
				font-size: 0.95rem;
				display: flex;
				align-items: center;
				gap: 0.75rem;
			}

			.risk-list li::before {
				content: "";
				width: 6px;
				height: 6px;
				background: var(--warm-accent);
				border-radius: 50%;
				flex-shrink: 0;
			}

			.risk-list li:last-child {
				border-bottom: none;
			}

			/* Email sent */
			.email-sent {
				background: white;
				padding: 1.25rem 1.5rem;
				border-radius: var(--border-radius);
				text-align: center;
				margin-bottom: 2rem;
				border: 1.5px solid rgba(5, 150, 105, 0.15);
			}

			.email-sent p {
				margin: 0;
				color: var(--accent);
				font-size: 0.95rem;
			}

			/* Video recommend */
			.video-recommend {
				margin-bottom: 2rem;
			}

			.video-recommend h2 {
				font-size: 1.1rem;
				margin-bottom: 1.25rem;
				font-weight: 600;
				text-align: center;
			}

			.video-embed {
				position: relative;
				padding-bottom: 177.78%; /* 9:16 vertical ratio for YouTube Shorts */
				height: 0;
				overflow: hidden;
				border-radius: var(--border-radius-lg);
				box-shadow: var(--box-shadow);
				max-width: 320px;
				margin: 0 auto;
			}

			.video-embed iframe {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
			}

			/* CTA section */
			.cta-section {
				background: linear-gradient(135deg, #059669 0%, #0d9488 50%, #14b8a6 100%);
				padding: 3rem 2rem;
				border-radius: var(--border-radius-lg);
				text-align: center;
				color: white;
				position: relative;
				overflow: hidden;
			}

			.cta-section::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
				pointer-events: none;
			}

			.cta-section h2 {
				color: white;
				margin-bottom: 0.75rem;
				position: relative;
				font-size: 1.5rem;
			}

			.cta-section p {
				opacity: 0.9;
				margin-bottom: 1.75rem;
				position: relative;
				font-size: 1rem;
			}

			.cta-btn {
				display: inline-flex;
				align-items: center;
				padding: 1rem 2rem;
				background: white;
				color: var(--accent);
				text-decoration: none;
				font-weight: 600;
				border-radius: var(--border-radius);
				transition: all var(--transition-fast);
				position: relative;
				box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
			}

			.cta-btn:hover {
				transform: translateY(-3px);
				box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
			}

			.back-link {
				display: block;
				margin-top: 1.25rem;
				color: rgba(255, 255, 255, 0.8);
				text-decoration: none;
				font-size: 0.95rem;
				position: relative;
				transition: color var(--transition-fast);
			}

			.back-link:hover {
				color: white;
			}

			/* No data state */
			#no-data {
				text-align: center;
				padding: 5rem 2rem;
				background: white;
				border-radius: var(--border-radius-lg);
				box-shadow: var(--box-shadow);
			}

			#no-data h1 {
				color: rgb(var(--black));
				margin-bottom: 0.75rem;
				font-size: 1.5rem;
			}

			#no-data p {
				color: rgb(var(--gray));
				margin-bottom: 2rem;
			}
		</style>

		<script>
			// Video recommendations based on concern (YouTube Shorts)
			const videoRecommendations: Record<string, string> = {
				weight: 'c94gPh3QRdE',
				fatigue: '4B2Fj36uWJI',
				metabolic: 'mnBuviTSD5Y',
				sleep: '4B2Fj36uWJI',
				other: 'c94gPh3QRdE'
			};

			// Risk messages based on score ranges
			const riskMessages: Record<string, string[]> = {
				low: [
					'維持目前良好的生活習慣',
					'可考慮進階的代謝優化策略'
				],
				medium: [
					'餐後血糖波動較大（餐後嗜睡）',
					'運動量不足，線粒體功能待提升',
					'睡眠品質影響代謝恢復'
				],
				high: [
					'代謝靈活性明顯下降',
					'胰島素阻抗風險較高',
					'建議盡快進行專業代謝評估',
					'生活型態需要系統性調整'
				]
			};

			// Load result from sessionStorage
			document.addEventListener('DOMContentLoaded', () => {
				const loading = document.getElementById('loading') as HTMLElement;
				const resultContent = document.getElementById('result-content') as HTMLElement;
				const noData = document.getElementById('no-data') as HTMLElement;

				const resultDataStr = sessionStorage.getItem('quizResult');

				if (!resultDataStr) {
					loading.style.display = 'none';
					noData.style.display = 'block';
					return;
				}

				const resultData = JSON.parse(resultDataStr);

				// Simulate loading
				setTimeout(() => {
					loading.style.display = 'none';
					resultContent.style.display = 'block';

					// Display metabolic age
					const metabolicAgeEl = document.getElementById('metabolic-age') as HTMLElement;
					const actualAgeEl = document.getElementById('actual-age') as HTMLElement;
					const ageDiffEl = document.getElementById('age-diff') as HTMLElement;
					const userEmailEl = document.getElementById('user-email') as HTMLElement;
					const riskListEl = document.getElementById('risk-list') as HTMLElement;
					const videoEl = document.getElementById('recommended-video') as HTMLIFrameElement;

					metabolicAgeEl.textContent = resultData.metabolicAge.toString();
					actualAgeEl.textContent = resultData.actualAge.toString();
					userEmailEl.textContent = resultData.email;

					// Calculate and display age difference
					const diff = resultData.metabolicAge - resultData.actualAge;
					if (diff <= 5) {
						metabolicAgeEl.style.color = 'var(--health-green)';
						ageDiffEl.className = 'age-diff good';
						ageDiffEl.textContent = diff <= 0
							? '太棒了！代謝年齡與實際年齡相當'
							: `代謝年齡比實際年齡大 ${diff} 歲`;
					} else if (diff <= 15) {
						metabolicAgeEl.style.color = 'var(--accent)';
						ageDiffEl.className = 'age-diff warning';
						ageDiffEl.textContent = `代謝年齡比實際年齡大 ${diff} 歲`;
					} else {
						metabolicAgeEl.style.color = '#dc2626';
						ageDiffEl.className = 'age-diff danger';
						ageDiffEl.textContent = `代謝年齡比實際年齡大 ${diff} 歲`;
					}

					// Display risk messages
					let riskLevel = 'low';
					if (diff > 15) riskLevel = 'high';
					else if (diff > 5) riskLevel = 'medium';

					const risks = riskMessages[riskLevel];
					riskListEl.innerHTML = risks.map(r => `<li>${r}</li>`).join('');

					// Set recommended video (YouTube Shorts use /shorts/ path)
					const videoId = videoRecommendations[resultData.mainConcern] || videoRecommendations.other;
					videoEl.src = `https://www.youtube.com/embed/${videoId}?loop=1`;

				}, 1500);
			});
		</script>
	</body>
</html>
